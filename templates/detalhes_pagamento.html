<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Comprovante de Pagamento - Águas de Santa Maria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta
      name="description"
      content="Comprovante de pagamento - Águas de Santa Maria"
    />
    <meta name="author" content="Águas de Santa Maria" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Sistema de Design - Cores e Tipografia (Sem alterações aqui) */
      :root {
        --primary-blue: #0d6efd;
        --primary-dark: #052c65;
        --secondary-gray: #6c757d;
        --success-green: #198754;
        --danger-red: #dc3545;
        --warning-yellow: #ffc107;
        --light-gray-bg: #f8f9fa;
        --medium-gray-border: #e9ecef;
        --dark-text: #212529;
        --muted-text: #6c757d;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--light-gray-bg);
        color: var(--dark-text);
        line-height: 1.4;
        font-size: 13px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .receipt-container {
        max-width: 650px;
        width: 100%;
        margin: 1.5rem auto;
        padding: 1.5rem 2rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .comprovante-header {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--primary-dark)
        );
        color: white;
        padding: 1rem;
        text-align: center;
        border-bottom: 3px solid rgba(255, 255, 255, 0.15);
        margin-bottom: 1.5rem;
      }
      .comprovante-header h1 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
      }
      .comprovante-header p {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 0;
      }
      .receipt-body {
        padding: 1rem;
      }
      .receipt-section {
        margin-bottom: 1.2rem;
        border: 1px solid var(--medium-gray-border);
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .section-header {
        background-color: var(--light-gray-bg);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--medium-gray-border);
      }
      .section-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-blue);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .section-content {
        padding: 1rem;
      }
      .info-pair-line {
        display: grid;
        grid-template-columns: minmax(80px, auto) 1fr;
        gap: 0.3rem 0.8rem;
        align-items: baseline;
        margin-bottom: 0.5rem;
      }
      .info-pair-line:last-child {
        margin-bottom: 0;
      }
      .info-label {
        font-size: 0.85rem;
        color: var(--muted-text);
        font-weight: 500;
        text-transform: uppercase;
        text-align: left;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .info-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--dark-text);
        text-align: right;
        word-break: break-word;
        flex-grow: 1;
      }
      .value-currency {
        font-family: "Roboto Mono", monospace;
        font-weight: 600;
      }
      .total-summary {
        background: linear-gradient(to right, #e8f5e9, #f1f8e9);
        border: 1px solid #c8e6c9;
        border-radius: 0.5rem;
        padding: 1.2rem;
        text-align: center;
        margin: 1.5rem 0 1rem;
      }
      .total-summary .label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2e7d32;
        text-transform: uppercase;
        margin-bottom: 0.3rem;
      }
      .total-summary .amount {
        font-size: 2rem;
        font-weight: 700;
        color: #2e7d32;
        font-family: "Roboto Mono", monospace;
        margin-bottom: 0.3rem;
      }
      .total-summary .status {
        font-size: 1rem;
        font-weight: 700;
        margin-top: 5px;
      }
      .notes-section {
        padding: 1rem;
        text-align: center;
        border-top: 1px solid var(--medium-gray-border);
        font-size: 0.8rem;
        color: var(--muted-text);
        margin-top: 1rem;
      }
      .action-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.6rem;
        padding: 1.2rem;
        background-color: var(--light-gray-bg);
        border-top: 1px solid var(--medium-gray-border);
        border-bottom-left-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
        margin-top: 1.5rem;
      }
      .btn-action {
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 0.4rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
      }
      .text-success-alt {
        color: #198754 !important;
      }
      .text-danger-alt {
        color: #dc3545 !important;
      }
      .text-warning-alt {
        color: #ffc107 !important;
      }
      .highlight {
        font-weight: 700;
      }

      /* ========================================================================= */
      /* ESTILOS PARA IMPRESSÃO (A4) - VERSÃO SUPER OTIMIZADA PARA UMA PÁGINA */
      /* ========================================================================= */
      @media print {
        @page {
          size: A4;
          margin: 10mm; /* Mantemos uma margem segura */
        }
        body {
          background: white;
          font-size: 8.5pt; /* AJUSTE FINAL: Reduzido um pouco a fonte base */
          line-height: 1.2; /* AJUSTE FINAL: Linha um pouco mais justa */
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .no-print {
          display: none !important;
        }
        .receipt-container {
          max-width: 100%;
          width: 100%;
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          border: none !important;
          border-radius: 0 !important;
        }

        /* AJUSTE FINAL: Redução ainda maior de margens e paddings */
        .comprovante-header {
          padding: 6mm 5mm; /* Reduzido */
          margin-bottom: 5mm; /* Reduzido */
        }
        .comprovante-header h1 {
          font-size: 1.4rem;
        }
        .comprovante-header p {
          font-size: 0.85rem;
        }

        .receipt-body {
          padding: 0;
        }

        .receipt-section {
          margin-bottom: 3mm !important; /* Reduzido */
          border-radius: 0 !important;
          padding: 0 !important;
          border: 1px solid #e9ecef !important;
        }
        .section-header {
          padding: 2.5mm 5mm; /* Reduzido */
          margin-bottom: 0;
        }
        .section-header h2 {
          font-size: 0.85rem;
        }

        .section-content {
          padding: 3mm 5mm; /* Reduzido */
        }

        .info-pair-line {
          gap: 1.5mm 5mm;
          margin-bottom: 2mm; /* Reduzido */
        }
        .info-label,
        .info-value {
          font-size: 8pt !important; /* Reduzido */
        }

        /* Ajuste no resumo financeiro para economizar espaço */
        .info-pair-line .info-label[style*="grid-column"],
        .info-pair-line .info-value[style*="grid-column"] {
          margin-top: 1mm !important;
          padding-top: 1mm !important;
        }

        .total-summary {
          padding: 5mm 8mm; /* Reduzido */
          margin-top: 4mm; /* Reduzido */
          margin-bottom: 4mm; /* Reduzido */
          border-radius: 0 !important;
        }
        .total-summary .label {
          font-size: 0.85rem;
        }
        .total-summary .amount {
          font-size: 1.5rem;
        } /* Reduzido */
        .total-summary .status,
        .total-summary .date {
          font-size: 0.8rem;
        }

        .notes-section {
          margin-top: 4mm !important; /* Reduzido */
          padding-top: 3mm !important; /* Reduzido */
          font-size: 7.5pt;
          text-align: center;
        }
        .action-bar {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="receipt-container">
      <header class="comprovante-header">
        <h1>Águas de Santa Maria</h1>
        <p>Comprovante de Pagamento</p>
      </header>

      <main class="receipt-body">
        <section class="receipt-section">
          <div class="section-header">
            <h2>Detalhes do Pagamento</h2>
          </div>
          <div class="section-content">
            <div class="info-pair-line">
              <span class="info-label">Fatura Referência:</span>
              <span class="info-value highlight">#{{ leitura.id }}</span>

              <span class="info-label">Data do Pagamento:</span>
              <span class="info-value">{{ data_emissao }}</span>

              <span class="info-label">Forma de Pagamento:</span>
              <span class="info-value">
                {{ pagamentos_feitos[0].forma_pagamento if pagamentos_feitos
                else 'N/A' }}
              </span>

              <span class="info-label">Valor Pago:</span>
              <span
                class="info-value value-currency text-success-alt highlight"
              >
                R$ {{ "%.2f"|format(total_pago_acumulado|float) | replace('.',
                ',') }}
              </span>
            </div>
          </div>
        </section>

        <section class="receipt-section">
          <div class="section-header">
            <h2>Dados do Consumidor</h2>
          </div>
          <div class="section-content">
            <div class="info-pair-line">
              <span class="info-label">Nome:</span>
              <span class="info-value">{{ leitura.consumidor_nome }}</span>

              <span class="info-label">Hidrômetro Nº:</span>
              <span class="info-value">{{ leitura.hidrometro or "N/C" }}</span>

              <span class="info-label">Endereço:</span>
              <span class="info-value"
                >{{ leitura.consumidor_endereco or "Não informado" }}</span
              >

              <span class="info-label">Telefone:</span>
              <span class="info-value"
                >{{ leitura.telefone or "Não informado" }}</span
              >
            </div>
          </div>
        </section>

        <section class="receipt-section">
          <div class="section-header">
            <h2>Informações da Fatura</h2>
          </div>
          <div class="section-content">
            <div class="info-pair-line">
              <span class="info-label">Competência:</span>
              <span class="info-value"
                >{{ leitura.data_leitura_atual.strftime('%m/%Y') }}</span
              >

              <span class="info-label">Período de Consumo:</span>
              <span class="info-value">{{ periodo_consumo }}</span>

              <span class="info-label">Consumo (m³):</span>
              <span class="info-value"
                >{{ "%g"|format(consumo_m3|int) }} m³</span
              >

              <span class="info-label">Vencimento Original:</span>
              <span class="info-value">{{ vencimento_formatado }}</span>
            </div>
          </div>
        </section>

        <section class="receipt-section">
          <div class="section-header">
            <h2>Resumo Financeiro da Fatura</h2>
          </div>
          <div class="section-content">
            <div class="info-pair-line">
              <span class="info-label">Valor Original da Fatura:</span>
              <span class="info-value currency"
                >R$ {{ "%.2f"|format(leitura.valor_original|float) |
                replace('.', ',') }}</span
              >

              {% if total_juros_multa_pago > 0 %}
              <span class="info-label">Juros/Multas Pagos:</span>
              <span class="info-value currency"
                >R$ {{ "%.2f"|format(total_juros_multa_pago|float) |
                replace('.', ',') }}</span
              >
              {% endif %} {% if multa_atual > 0 or juros_atual > 0 %}
              <span class="info-label text-danger-alt"
                >Multas/Juros Pendentes:</span
              >
              <span class="info-value currency text-danger-alt">
                R$ {{ "%.2f"|format(multa_atual + juros_atual|float) |
                replace('.', ',') }}
              </span>
              {% endif %}

              <span
                class="info-label highlight"
                style="
                  grid-column: 1 / -1;
                  text-align: center;
                  margin-top: 0.3rem;
                  margin-bottom: 0.1rem;
                  border-top: 1px dashed var(--medium-gray-border);
                  padding-top: 0.1rem;
                "
                >SALDO REMANESCENTE:</span
              >
              <span
                class="info-value currency highlight {% if saldo_final > 0 %}text-danger-alt{% else %}text-success-alt{% endif %}"
                style="
                  grid-column: 1 / -1;
                  text-align: center;
                  font-size: 1.1em;
                "
              >
                R$ {{ "%.2f"|format(saldo_final|float) | replace('.', ',') }}
              </span>

              <span class="info-label">Status da Fatura:</span>
              <span
                class="info-value fw-bold {% if 'Quitada' in situacao_da_fatura_texto %}text-success-alt{% elif 'Vencida' in situacao_da_fatura_texto %}text-danger-alt{% else %}text-warning-alt{% endif %}"
              >
                {{ situacao_da_fatura_texto }}
              </span>
            </div>
          </div>
        </section>

        <div class="total-summary">
          <p class="label">VALOR TOTAL DO PAGAMENTO</p>
          <p class="amount value-currency">
            R$ {{ "%.2f"|format(total_pago_acumulado|float) | replace('.', ',')
            }}
          </p>
          <p class="date">Registrado em: {{ data_emissao }}</p>
          <p
            class="status {% if 'Quitada' in situacao_da_fatura_texto %}text-success-alt{% elif 'Vencida' in situacao_da_fatura_texto %}text-danger-alt{% else %}text-warning-alt{% endif %}"
          >
            {{ situacao_da_fatura_texto }}
          </p>
        </div>

        <div class="notes-section">
          <p>
            Este comprovante é válido como prova de pagamento da fatura
            indicada.
          </p>
          <p>
            Para dúvidas ou informações adicionais, entre em contato com a Águas
            de Santa Maria.
          </p>
        </div>
      </main>

      <div class="action-bar no-print">
        <a
          href="{{ url_for('listar_pagamentos') }}"
          class="btn-action btn btn-secondary"
        >
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <button onclick="window.print()" class="btn-action btn btn-primary">
          <i class="fas fa-print"></i> Imprimir / Gerar PDF
        </button>
        {% if whatsapp_phone_number and whatsapp_message %}
        <a
          href="https://wa.me/{{ whatsapp_phone_number }}?text={{ whatsapp_message }}"
          target="_blank"
          class="btn-action btn btn-success"
        >
          <i class="fab fa-whatsapp"></i> Enviar WhatsApp
        </a>
        {% endif %}
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      function generatePDF() {
        const element = document.querySelector(".receipt-container");
        const opt = {
          margin: [10, 10, 10, 10],
          filename: "comprovante-pagamento-aguas-santa-maria.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: {
            scale: 2,
            letterRendering: true,
            useCORS: true,
          },
          jsPDF: {
            unit: "mm",
            format: "a4",
            orientation: "portrait",
            putOnlyUsedFonts: true,
          },
          pagebreak: {
            mode: "avoid-all",
          },
        };

        html2pdf().set(opt).from(element).save();
      }
    </script>
  </body>
</html>
