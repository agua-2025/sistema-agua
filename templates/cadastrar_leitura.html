<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Leitura - Águas de Santa Maria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container-form { max-width: 900px; background-color: #fff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); margin: 2rem auto; }
        .form-label { font-weight: 600; }
        .form-control[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .is-invalid { border-color: #dc3545 !important; }
        .invalid-feedback { display: none; width: 100%; margin-top: .25rem; font-size: .875em; color: #dc3545; }
        .is-invalid ~ .invalid-feedback { display: block; }
    </style>
</head>
<body class="bg-light">
    <div class="container container-form">
        <div class="text-center mb-4">
            <h3 class="mb-1 text-primary"><i class="fas fa-tachometer-alt me-2"></i>Cadastrar Leitura</h3>
            <p class="text-muted">Preencha os dados da nova leitura.</p>
        </div>
        
        {% include '_flash_messages.html' %}

       <form method="POST" enctype="multipart/form-data" id="leitura-form">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="consumidor_id" class="form-label">Consumidor <span class="text-danger">*</span></label>
                    <select class="form-select" id="consumidor_id" name="consumidor_id" required>
                        <option value="" disabled {% if not consumidor_selecionado %}selected{% endif %}>Selecione um consumidor</option>
                        {% for consumidor in consumidores %}
                        <option value="{{ consumidor.id }}" {% if consumidor.id == consumidor_selecionado %}selected{% endif %}>
                            {{ consumidor.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_anterior" class="form-label">Data da Leitura Anterior</label>
                    <input type="text" class="form-control" id="data_leitura_anterior" name="data_leitura_anterior" value="{{ data_leitura_anterior or 'N/A' }}" readonly>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="leitura_anterior" class="form-label">Leitura Anterior (m³)</label>
                    <input type="text" class="form-control" id="leitura_anterior" name="leitura_anterior" value="{{ leitura_anterior or '0' }}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_atual" class="form-label">Data da Leitura Atual <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="data_leitura_atual" name="data_leitura_atual" value="{{ today_date }}" required>
                    <div id="data-atual-feedback" class="invalid-feedback"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="leitura_atual" class="form-label">Leitura Atual (m³) <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="leitura_atual" name="leitura_atual" required placeholder="0">
                    <div id="leitura-atual-feedback" class="invalid-feedback">Deve ser maior que a anterior.</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="qtd_dias_utilizados" class="form-label">Dias Utilizados</label>
                    <input type="text" class="form-control" id="qtd_dias_utilizados" name="qtd_dias_utilizados" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="media_por_dia" class="form-label">Média por Dia (m³)</label>
                    <input type="text" class="form-control" id="media_por_dia" name="media_por_dia" readonly>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <label for="consumo_m3" class="form-label">Consumo (m³)</label>
                    <input type="text" class="form-control" id="consumo_m3" name="consumo_m3" readonly>
                </div>
            </div>
           <div class="row">
    <div class="col-12 mb-3">
        <label for="foto_hidrometro" class="form-label">Foto do Hidrômetro (Opcional)</label>
        <input class="form-control" type="file" id="foto_hidrometro" name="foto_hidrometro" accept="image/*">
            </div>
            </div>    
            <div class="row">
                   <div class="col-md-6 mb-3">
                    <label for="valor_original" class="form-label fw-bold">Valor Original da Fatura (R$)</label>
                    <input type="text" class="form-control fs-5 fw-bold text-success" id="valor_original" name="valor_original" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="vencimento" class="form-label fw-bold">Data de Vencimento</label>
                    <input type="date" class="form-control" id="vencimento" name="vencimento" readonly>
                </div>
            </div>
            <hr class="my-4">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i>Salvar Leitura</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('consumidor_id')?.addEventListener('change', function() {
                if (this.value) window.location.href = `/cadastrar-leitura?consumidor_id=${this.value}`;
            });

            const DOM = {
                form: document.getElementById('leitura-form'),
                leituraAnterior: document.getElementById('leitura_anterior'),
                leituraAtual: document.getElementById('leitura_atual'),
                dataAnterior: document.getElementById('data_leitura_anterior'),
                dataAtual: document.getElementById('data_leitura_atual'),
                consumoM3: document.getElementById('consumo_m3'),
                diasUtilizados: document.getElementById('qtd_dias_utilizados'),
                mediaDiaria: document.getElementById('media_por_dia'),
                valorOriginal: document.getElementById('valor_original'),
                vencimento: document.getElementById('vencimento'),
                feedbackLeitura: document.getElementById('leitura-atual-feedback'),
                feedbackData: document.getElementById('data-atual-feedback')
            };

            let appConfig = { 
                valorM3: 0.0, 
                diasVencimento: 5, 
                taxaMinimaValor: 0.0, 
                taxaMinimaFranquiaM3: 10.0 
            };

            const Utils = {
                parsearFloat: (str) => parseFloat(String(str).replace(/[^0-9,.]/g, '').replace(',', '.')) || 0,
                formatarBRL: (num) => (num || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                formatarDecimal: (num) => (num || 0).toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }),
                adicionarDiasUteis: (data, dias) => {
                    let d = new Date(data.valueOf());
                    let diasAdicionados = 0;
                    while (diasAdicionados < dias) {
                        d.setDate(d.getDate() + 1);
                        if (d.getDay() > 0 && d.getDay() < 6) diasAdicionados++;
                    }
                    return d;
                }
            };
            
            function validarEntradas() {
                let isFormValido = true;
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);

                const leituraAnterior = Utils.parsearFloat(DOM.leituraAnterior.value);
                const leituraAtual = Utils.parsearFloat(DOM.leituraAtual.value);
                
                // Apenas valida se leituraAtual é menor que leituraAnterior se a leitura anterior não for 0
                if (leituraAnterior !== 0 && leituraAtual > 0 && leituraAtual < leituraAnterior) {
                    DOM.leituraAtual.classList.add('is-invalid');
                    isFormValido = false;
                } else {
                    DOM.leituraAtual.classList.remove('is-invalid');
                }

                const dataAtualStr = DOM.dataAtual.value;
                DOM.dataAtual.classList.remove('is-invalid');
                if (dataAtualStr) {
                    const dataAtual = new Date(dataAtualStr + 'T00:00:00');
                    if (dataAtual > hoje) {
                        DOM.dataAtual.classList.add('is-invalid');
                        DOM.feedbackData.textContent = 'A data não pode ser futura.';
                        isFormValido = false;
                    } else {
                        const dataAnteriorStr = DOM.dataAnterior.value;
                        if (dataAnteriorStr !== 'N/A') {
                            const partes = dataAnteriorStr.split('/');
                            const dataAnterior = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
                            if (dataAtual < dataAnterior) {
                                DOM.dataAtual.classList.add('is-invalid');
                                DOM.feedbackData.textContent = 'A data não pode ser anterior à passada.';
                                isFormValido = false;
                            }
                        }
                    }
                } else {
                    isFormValido = false;
                }
                return isFormValido;
            }

            function calcularEAtualizarTela() {
                const isValido = validarEntradas();
                const leituraAnterior = Utils.parsearFloat(DOM.leituraAnterior.value);
                const leituraAtual = Utils.parsearFloat(DOM.leituraAtual.value);
                const dataAnteriorStr = DOM.dataAnterior.value; // Para verificar se é a primeira leitura

                let consumo = 0;
                // O consumo é a leitura atual apenas se for a primeira leitura
                // Caso contrário, é a diferença entre a leitura atual e a anterior
                if (leituraAnterior === 0 && dataAnteriorStr === 'N/A') { // É a primeira leitura
                    consumo = leituraAtual; // O consumo inicial é a própria leitura atual
                } else if (leituraAtual > leituraAnterior) {
                    consumo = leituraAtual - leituraAnterior;
                }
                DOM.consumoM3.value = consumo.toString();

                const dataAtualStr = DOM.dataAtual.value;
                let dias = 0;
                if (dataAnteriorStr !== 'N/A' && dataAtualStr && isValido) {
                    try {
                        const partes = dataAnteriorStr.split('/');
                        const dataAnterior = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
                        const dataAtual = new Date(dataAtualStr + 'T00:00:00');
                        dias = Math.round((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
                    } catch { dias = 0; }
                }
                DOM.diasUtilizados.value = dias > 0 ? dias : 0;
                
                const media = (consumo > 0 && dias > 0) ? consumo / dias : 0;
                DOM.mediaDiaria.value = Utils.formatarDecimal(media);

                // --- LÓGICA DE CÁLCULO DA FRANQUIA (AJUSTADA PARA PRIMEIRA LEITURA) ---
                let valorFinal = 0;

                // Se for a primeira leitura (leitura anterior 0 e data anterior N/A), o valor deve ser 0.
                if (leituraAnterior === 0 && dataAnteriorStr === 'N/A') {
                    valorFinal = 0; 
                } else if (consumo > 0 && isValido) {
                    if (consumo <= appConfig.taxaMinimaFranquiaM3) {
                        valorFinal = appConfig.taxaMinimaValor;
                    } else {
                        const consumoExcedente = consumo - appConfig.taxaMinimaFranquiaM3;
                        const valorExcedente = consumoExcedente * appConfig.valorM3;
                        valorFinal = appConfig.taxaMinimaValor + valorExcedente;
                    }
                }
                DOM.valorOriginal.value = Utils.formatarBRL(valorFinal);

                if (valorFinal > 0 && dataAtualStr && isValido) {
                    const dataLeitura = new Date(dataAtualStr + 'T00:00:00');
                    const dataVencimento = Utils.adicionarDiasUteis(dataLeitura, appConfig.diasVencimento);
                    DOM.vencimento.value = dataVencimento.toISOString().split('T')[0];
                } else {
                    // Limpa a data de vencimento se o valor final for 0
                    DOM.vencimento.value = ''; 
                }
            }

            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('/api/configuracoes-leitura');
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar configurações da API. Status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    appConfig.valorM3 = Utils.parsearFloat(data.valor_m3);
                    appConfig.diasVencimento = parseInt(data.dias_uteis) || 5;
                    appConfig.taxaMinimaValor = Utils.parsearFloat(data.taxa_minima_valor);
                    appConfig.taxaMinimaFranquiaM3 = Utils.parsearFloat(data.taxa_minima_franquia_m3);

                } catch (error) {
                    console.error('Erro ao carregar configurações do sistema:', error);
                    alert('Não foi possível carregar as configurações do sistema. Os cálculos podem não funcionar corretamente.');
                }
                calcularEAtualizarTela(); // Chama o cálculo após carregar as configurações
            }

            ['leitura_atual', 'data_leitura_atual'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', calcularEAtualizarTela);
            });

            DOM.form.addEventListener('submit', function(event) {
                if (!validarEntradas()) {
                    event.preventDefault();
                    alert('Por favor, corrija os erros indicados no formulário antes de salvar.');
                }
            });

            carregarConfiguracoes(); // Inicia o carregamento e cálculo
        });
    </script>
</body>
</html>