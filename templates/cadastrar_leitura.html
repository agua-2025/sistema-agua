<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Leitura - Águas de Santa Maria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container-form { max-width: 900px; background-color: #fff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); margin: 2rem auto; }
        .form-label { font-weight: 600; }
        .form-control[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .is-invalid { border-color: #dc3545 !important; }
        .invalid-feedback { display: none; width: 100%; margin-top: .25rem; font-size: .875em; color: #dc3545; }
        .is-invalid ~ .invalid-feedback { display: block; }
    </style>
</head>
<body class="bg-light">
    <div class="container container-form">
        <div class="text-center mb-4">
            <h3 class="mb-1 text-primary"><i class="fas fa-tachometer-alt me-2"></i>Cadastrar Leitura</h3>
            <p class="text-muted">Preencha os dados da nova leitura.</p>
        </div>
        
        {% include '_flash_messages.html' %}

        <form method="POST" enctype="multipart/form-data" id="leitura-form">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="consumidor_id" class="form-label">Consumidor <span class="text-danger">*</span></label>
                    <select class="form-select" id="consumidor_id" name="consumidor_id" required>
                        <option value="" disabled {% if not consumidor_selecionado %}selected{% endif %}>Selecione um consumidor</option>
                        {% for consumidor in consumidores %}
                        <option value="{{ consumidor.id }}" {% if consumidor.id == consumidor_selecionado %}selected{% endif %}>
                            {{ consumidor.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_anterior" class="form-label">Data da Leitura Anterior</label>
                    <input type="text" class="form-control" id="data_leitura_anterior" name="data_leitura_anterior" value="{{ data_leitura_anterior or 'N/A' }}" readonly>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="leitura_anterior" class="form-label">Leitura Anterior (m³)</label>
                    <input type="text" class="form-control" id="leitura_anterior" name="leitura_anterior" value="{{ leitura_anterior or '0' }}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_atual" class="form-label">Data da Leitura Atual <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="data_leitura_atual" name="data_leitura_atual" value="{{ today_date }}" required>
                    <div id="data-atual-feedback" class="invalid-feedback"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="leitura_atual" class="form-label">Leitura Atual (m³) <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="leitura_atual" name="leitura_atual" required placeholder="0">
                    <div id="leitura-atual-feedback" class="invalid-feedback">A leitura atual não pode ser menor que a anterior.</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="qtd_dias_utilizados" class="form-label">Dias de Consumo</label>
                    <input type="text" class="form-control" id="qtd_dias_utilizados" name="qtd_dias_utilizados" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="media_por_dia" class="form-label">Média por Dia (m³)</label>
                    <input type="text" class="form-control" id="media_por_dia" name="media_por_dia" readonly>
                </div>
            </div>

            <div class="row">
                <div class="col-12 mb-3">
                    <label for="consumo_m3" class="form-label">Consumo (m³)</label>
                    <input type="text" class="form-control" id="consumo_m3" name="consumo_m3" readonly>
                </div>
            </div>

            <div class="row align-items-end">
                <div class="col-md-6 mb-3">
                    <label for="taxa_minima_aplicada" class="form-label">Aplicar Taxa Mínima?</label>
                    <select class="form-select" id="taxa_minima_aplicada" name="taxa_minima_aplicada">
                        <option value="NÃO" selected>Não</option>
                        <option value="SIM">Sim</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="valor_taxa_minima" class="form-label">Valor da Taxa (R$)</label>
                    <input type="text" class="form-control" id="valor_taxa_minima" name="valor_taxa_minima" placeholder="0,00">
                </div>
            </div>
            
            <div class="row">
                 <div class="col-md-6 mb-3">
                    <label for="valor_original" class="form-label fw-bold">Valor da Fatura (R$)</label>
                    <input type="text" class="form-control fs-5 fw-bold text-success" id="valor_original" name="valor_original" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="vencimento" class="form-label fw-bold">Data de Vencimento</label>
                    <input type="date" class="form-control" id="vencimento" name="vencimento" readonly>
                </div>
            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4"><i class="fas fa-save me-1"></i>Salvar Leitura</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const consumidorSelect = document.getElementById('consumidor_id');
            if (consumidorSelect) {
                consumidorSelect.addEventListener('change', () => {
                    if (consumidorSelect.value) {
                        window.location.href = `/cadastrar-leitura?consumidor_id=${consumidorSelect.value}`;
                    }
                });
            }

            const DOM = {
                leituraAnterior: document.getElementById('leitura_anterior'),
                leituraAtual: document.getElementById('leitura_atual'),
                dataAnterior: document.getElementById('data_leitura_anterior'),
                dataAtual: document.getElementById('data_leitura_atual'),
                consumoM3: document.getElementById('consumo_m3'),
                diasUtilizados: document.getElementById('qtd_dias_utilizados'),
                mediaDiaria: document.getElementById('media_por_dia'),
                aplicarTaxaMinima: document.getElementById('taxa_minima_aplicada'),
                valorTaxaMinima: document.getElementById('valor_taxa_minima'),
                valorOriginal: document.getElementById('valor_original'),
                vencimento: document.getElementById('vencimento'),
                dataAtualFeedback: document.getElementById('data-atual-feedback'),
                leituraAtualFeedback: document.getElementById('leitura-atual-feedback')
            };

            let appConfig = { valorM3: 0.0, diasVencimento: 10 };

            const Utils = {
                parseInteger: (str) => parseInt(String(str), 10) || 0,
                parseFloat: (str) => parseFloat(String(str || '0').replace(/,/g, '.')) || 0,
                formatInteger: (num) => String(Math.round(num || 0)),
                formatDecimal: (num, casas = 3) => (num || 0).toFixed(casas).replace('.',','),
                formatToBRL: (num) => (num || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                adicionarDiasUteis: (data, dias) => {
                    let d = new Date(data.valueOf());
                    let diasAdicionados = 0;
                    while (diasAdicionados < dias) {
                        d.setDate(d.getDate() + 1);
                        if (d.getDay() > 0 && d.getDay() < 6) diasAdicionados++;
                    }
                    return d;
                }
            };
            
            function validarEntradas() {
                let dataValida = true;
                let leituraValida = true;

                DOM.dataAtual.classList.remove('is-invalid');
                const dataAtualStr = DOM.dataAtual.value;
                if (dataAtualStr) {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const dataAtualObj = new Date(dataAtualStr + 'T00:00:00');
                    if (dataAtualObj > hoje) {
                        DOM.dataAtual.classList.add('is-invalid');
                        DOM.dataAtualFeedback.textContent = 'A data não pode ser futura.';
                        dataValida = false;
                    }
                    const dataAnteriorStr = DOM.dataAnterior.value;
                    if (dataValida && dataAnteriorStr && dataAnteriorStr !== 'N/A') {
                        try {
                            const partes = dataAnteriorStr.split('/');
                            const dataAnteriorObj = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
                            if (dataAtualObj < dataAnteriorObj) {
                                DOM.dataAtual.classList.add('is-invalid');
                                DOM.dataAtualFeedback.textContent = 'A data não pode ser anterior à última leitura.';
                                dataValida = false;
                            }
                        } catch(e) { dataValida = false; }
                    }
                } else { dataValida = false; }

                DOM.leituraAtual.classList.remove('is-invalid');
                const leituraAnterior = Utils.parseInteger(DOM.leituraAnterior.value);
                const leituraAtual = Utils.parseInteger(DOM.leituraAtual.value);
                if (DOM.leituraAtual.value === '') {
                    leituraValida = false;
                } else if (leituraAtual < leituraAnterior) {
                    DOM.leituraAtual.classList.add('is-invalid');
                    leituraValida = false;
                }
                
                return { dataValida, leituraValida };
            }

            function calcularEAtualizarTela() {
                const { dataValida, leituraValida } = validarEntradas();
                
                const leituraAnterior = Utils.parseInteger(DOM.leituraAnterior.value);
                const leituraAtual = Utils.parseInteger(DOM.leituraAtual.value);
                
                const consumo = leituraValida ? (leituraAtual - leituraAnterior) : 0;
                DOM.consumoM3.value = Utils.formatInteger(consumo);
                
                // --- CORREÇÃO DIAS E MÉDIA ---
                let dias = 0;
                let foiPossivelCalcularDias = false;

                if (dataValida && DOM.dataAnterior.value && DOM.dataAnterior.value !== 'N/A') {
                    try {
                        const partes = DOM.dataAnterior.value.split('/');
                        const dataAnterior = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T00:00:00`);
                        const dataAtual = new Date(DOM.dataAtual.value + 'T00:00:00');
                        dias = Math.max(0, Math.round((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24)));
                        foiPossivelCalcularDias = true;
                    } catch { 
                        foiPossivelCalcularDias = false;
                    }
                }
                
                // Mostra o valor de 'dias' se foi possível calcular, senão, mostra vazio.
                DOM.diasUtilizados.value = foiPossivelCalcularDias ? dias : '';

                const media = (consumo > 0 && dias > 0) ? consumo / dias : 0;
                DOM.mediaDiaria.value = Utils.formatDecimal(media, 3);
                // --- FIM DA CORREÇÃO ---
                
                let valorFinal = 0;
                if (consumo > 0) {
                    const valorCalculado = consumo * appConfig.valorM3;
                    const aplicarTaxa = DOM.aplicarTaxaMinima.value === 'SIM';
                    const taxaMinima = aplicarTaxa ? Utils.parseFloat(DOM.valorTaxaMinima.value) : 0;
                    valorFinal = Math.max(valorCalculado, taxaMinima);
                }
                DOM.valorOriginal.value = Utils.formatToBRL(valorFinal);

                if (valorFinal > 0 && dataValida) {
                    const dataLeitura = new Date(DOM.dataAtual.value + 'T00:00:00');
                    const dataVencimento = Utils.adicionarDiasUteis(dataLeitura, appConfig.diasVencimento);
                    DOM.vencimento.value = dataVencimento.toISOString().split('T')[0];
                } else {
                    DOM.vencimento.value = '';
                }
            }

            async function carregarConfiguracoesEIniciar() {
                const leituraAnteriorInicial = Utils.parseInteger(DOM.leituraAnterior.value);
                DOM.leituraAnterior.value = Utils.formatInteger(leituraAnteriorInicial);

                try {
                    const response = await fetch('/api/valor_m3');
                    if (!response.ok) {
                        throw new Error(`Erro de rede: ${response.statusText}`);
                    }
                    const data = await response.json();
                    appConfig.valorM3 = Utils.parseFloat(data.valor_m3);
                } catch (error) {
                    console.error('FALHA AO CARREGAR CONFIGURAÇÃO DE PREÇO:', error);
                    alert('ATENÇÃO: Não foi possível carregar as configurações de preço do servidor. O cálculo do valor da fatura não funcionará.');
                    appConfig.valorM3 = 0;
                }

                calcularEAtualizarTela();
            }

            ['input', 'change'].forEach(evento => {
                ['leitura_atual', 'data_leitura_atual', 'taxa_minima_aplicada', 'valor_taxa_minima'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener(evento, calcularEAtualizarTela);
                });
            });

            document.getElementById('leitura-form').addEventListener('submit', function(event) {
                const { dataValida, leituraValida } = validarEntradas();
                if (!dataValida || !leituraValida) {
                    event.preventDefault();
                    alert('Por favor, corrija os erros indicados no formulário antes de salvar.');
                }
            });

            carregarConfiguracoesEIniciar();
        });
    </script>
</body>
</html>