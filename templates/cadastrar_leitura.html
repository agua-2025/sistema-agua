<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Leitura - Águas de Santa Maria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container-form { max-width: 900px; background-color: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.08); margin: 20px auto; }
        .form-label { font-weight: 500; }
        .form-control[readonly] { background-color: #e9ecef; }
        .is-invalid { border-color: #dc3545 !important; }
        .invalid-feedback { display: block; }
    </style>
</head>
<body class="bg-light">
    <div class="container container-form">
        <h3 class="text-center mb-4"><i class="bi bi-speedometer2 me-2"></i>Cadastrar Leitura</h3>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="consumidor_id" class="form-label">Consumidor *</label>
                    <select class="form-select" id="consumidor_id" name="consumidor_id" required>
                        <option value="" disabled {% if not consumidor_selecionado %}selected{% endif %}>Selecione um consumidor</option>
                        {% for consumidor in consumidores %}
                        <option value="{{ consumidor.id }}" {% if consumidor.id == consumidor_selecionado %}selected{% endif %}>
                            {{ consumidor.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_anterior" class="form-label">Data da Leitura Anterior</label>
                    <input type="text" class="form-control" id="data_leitura_anterior" name="data_leitura_anterior" value="{{ data_leitura_anterior or '' }}" readonly>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="leitura_anterior" class="form-label">Leitura Anterior (L)</label>
                    <input type="text" class="form-control" id="leitura_anterior" name="leitura_anterior" value="{{ '%.2f'|format(leitura_anterior|float) }}" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="data_leitura_atual" class="form-label">Data da Leitura Atual *</label>
                    <input type="date" class="form-control" id="data_leitura_atual" name="data_leitura_atual" required max="{{ today_date }}">
                    <div id="data-atual-feedback" class="invalid-feedback">A data da leitura atual não é válida.</div>
                </div>
            </div>

            <hr class="my-3">

            <div class="row">
                   <div class="col-md-4 mb-3">
                    <label for="leitura_atual" class="form-label">Leitura Atual (L) *</label>
                    <input type="number" step="0.01" class="form-control" id="leitura_atual" name="leitura_atual" required>
                    <div id="leitura-atual-feedback" class="invalid-feedback">A leitura atual não pode ser menor que a anterior.</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="qtd_dias_utilizados" class="form-label">Dias Utilizados</label>
                    <input type="text" class="form-control" id="qtd_dias_utilizados" name="qtd_dias_utilizados" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="media_por_dia" class="form-label">Média por Dia (L)</label>
                    <input type="text" class="form-control" id="media_por_dia" name="media_por_dia" readonly>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label for="litros_consumidos" class="form-label">Litros Consumidos</label>
                    <input type="text" class="form-control" id="litros_consumidos" name="litros_consumidos" readonly>
                </div>
            </div>

            <div class="row align-items-end">
                <div class="col-md-6 mb-3">
                    <label for="taxa_minima_aplicada" class="form-label">Aplicar Taxa Mínima?</label>
                    <select class="form-select" id="taxa_minima_aplicada" name="taxa_minima_aplicada">
                        <option value="SIM">Sim</option>
                        <option value="NÃO" selected>Não</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="valor_taxa_minima" class="form-label">Valor da Taxa (R$)</label>
                    <input type="text" class="form-control" id="valor_taxa_minima" name="valor_taxa_minima" value="0,00">
                </div>
            </div>

            <hr class="my-3">
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="valor_original" class="form-label fw-bold">Valor Original da Fatura (R$)</label>
                    <input type="text" class="form-control" id="valor_original" name="valor_original" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="vencimento" class="form-label fw-bold">Data de Vencimento</label>
                    <input type="date" class="form-control" id="vencimento" name="vencimento" readonly>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4"><i class="bi bi-check-circle-fill me-2"></i>Salvar Leitura</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const DOM = {
                consumidor: document.getElementById('consumidor_id'),
                leituraAnterior: document.getElementById('leitura_anterior'),
                dataAnterior: document.getElementById('data_leitura_anterior'),
                leituraAtual: document.getElementById('leitura_atual'),
                dataAtual: document.getElementById('data_leitura_atual'),
                diasUtilizados: document.getElementById('qtd_dias_utilizados'),
                litrosConsumidos: document.getElementById('litros_consumidos'),
                mediaDiaria: document.getElementById('media_por_dia'),
                aplicarTaxaMinima: document.getElementById('taxa_minima_aplicada'),
                valorTaxaMinima: document.getElementById('valor_taxa_minima'),
                valorOriginal: document.getElementById('valor_original'),
                vencimento: document.getElementById('vencimento'),
                leituraAtualFeedback: document.getElementById('leitura-atual-feedback'),
                dataAtualFeedback: document.getElementById('data-atual-feedback') // Novo feedback para data
            };

            let appConfig = {
                valorM3: 0.0,
                diasVencimento: 5
            };

            const Utils = {
                parseLocalFloat: (str) => parseFloat(String(str).replace(',', '.')) || 0,
                formatLocalFloat: (num) => (num || 0).toFixed(2).replace('.', ','),
                adicionarDiasUteis: (dataInicialStr, dias) => {
                    let data = new Date(dataInicialStr + 'T00:00:00');
                    if (isNaN(data.getTime())) return null;

                    let diasAdicionados = 0;
                    let contadorSeguranca = 0; 

                    while (diasAdicionados < dias && contadorSeguranca < 100) {
                        data.setDate(data.getDate() + 1);
                        const diaDaSemana = data.getDay();
                        if (diaDaSemana > 0 && diaDaSemana < 6) {
                            diasAdicionados++;
                        }
                        contadorSeguranca++;
                    }
                    return data;
                }
            };

            const Calculations = {
                calcularConsumo: (leituraAnterior, leituraAtual) => {
                    if (leituraAtual > 0 && leituraAtual < leituraAnterior) {
                        DOM.leituraAtual.classList.add('is-invalid');
                        DOM.leituraAtualFeedback.style.display = 'block';
                        return 0;
                    }
                    DOM.leituraAtual.classList.remove('is-invalid');
                    DOM.leituraAtualFeedback.style.display = 'none';
                    return (leituraAtual > leituraAnterior) ? leituraAtual - leituraAnterior : 0;
                },
                calcularDiasUtilizados: (dataAnteriorStr, dataAtualStr) => {
                    if (!dataAnteriorStr || !dataAtualStr) return 0;
                    try {
                        const partesDataAnterior = dataAnteriorStr.split('/');
                        const dataAnteriorFormatada = `${partesDataAnterior[2]}-${partesDataAnterior[1]}-${partesDataAnterior[0]}`;
                        
                        const dateAnterior = new Date(dataAnteriorFormatada + 'T00:00:00');
                        const dateAtual = new Date(dataAtualStr + 'T00:00:00');

                        if (isNaN(dateAnterior.getTime()) || isNaN(dateAtual.getTime())) {
                            console.error("Datas inválidas para cálculo de dias:", dataAnteriorStr, dataAtualStr);
                            return 0;
                        }

                        if (dateAtual >= dateAnterior) {
                            const diffTime = dateAtual - dateAnterior;
                            return Math.round(diffTime / (1000 * 60 * 60 * 24));
                        }
                    } catch (e) {
                        console.error("Erro ao calcular dias:", e);
                    }
                    return 0;
                },
                calcularValorFatura: (consumoEmLitros) => {
                    const valorCalculado = (consumoEmLitros / 1000) * appConfig.valorM3;
                    const deveAplicarTaxa = DOM.aplicarTaxaMinima.value === 'SIM';
                    const taxaMinima = deveAplicarTaxa ? Utils.parseLocalFloat(DOM.valorTaxaMinima.value) : 0;
                    return Math.max(valorCalculado, taxaMinima);
                }
            };

            function updateAllCalculations() {
                const leituraAnterior = Utils.parseLocalFloat(DOM.leituraAnterior.value);
                const leituraAtual = Utils.parseLocalFloat(DOM.leituraAtual.value);
                const dataAnterior = DOM.dataAnterior.value;
                const dataAtual = DOM.dataAtual.value;

                const consumo = Calculations.calcularConsumo(leituraAnterior, leituraAtual);
                const dias = Calculations.calcularDiasUtilizados(dataAnterior, dataAtual);
                const media = (consumo > 0 && dias > 0) ? consumo / dias : 0;
                const valorFinal = Calculations.calcularValorFatura(consumo);

                DOM.litrosConsumidos.value = Utils.formatLocalFloat(consumo);
                DOM.diasUtilizados.value = dias;
                DOM.mediaDiaria.value = Utils.formatLocalFloat(media);
                DOM.valorOriginal.value = Utils.formatLocalFloat(valorFinal);
            }
            
            function updateVencimento() {
                const dataLeituraStr = DOM.dataAtual.value;
                if (!dataLeituraStr) {
                    DOM.vencimento.value = '';
                    return;
                }
                const dataVencimento = Utils.adicionarDiasUteis(dataLeituraStr, appConfig.diasVencimento);
                if (DOM.vencimento && dataVencimento) {
                    DOM.vencimento.value = dataVencimento.toISOString().split('T')[0];
                } else {
                    DOM.vencimento.value = '';
                }
            }

            function validateAndRecalculateDates() {
                const dataInserida = DOM.dataAtual.value;
                const dataAnteriorStr = DOM.dataAnterior.value;
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Zera horas para comparação de data

                DOM.dataAtual.classList.remove('is-invalid');
                DOM.dataAtualFeedback.style.display = 'none';
                DOM.dataAtualFeedback.textContent = 'A data da leitura atual não é válida.'; // Reset default message

                if (!dataInserida || dataInserida.length < 10) {
                    DOM.dataAtual.classList.add('is-invalid');
                    DOM.dataAtualFeedback.textContent = 'Preencha a data da leitura atual.';
                    DOM.dataAtualFeedback.style.display = 'block';
                    clearDependentDateFields();
                    return;
                }
                
                const dataAtualDate = new Date(dataInserida + 'T00:00:00');

                if (isNaN(dataAtualDate.getTime())) {
                    DOM.dataAtual.classList.add('is-invalid');
                    DOM.dataAtualFeedback.textContent = 'Formato de data inválido.';
                    DOM.dataAtualFeedback.style.display = 'block';
                    clearDependentDateFields();
                    return;
                }

                // Validação: não pode ser superior à data de hoje
                if (dataAtualDate > today) {
                    DOM.dataAtual.classList.add('is-invalid');
                    DOM.dataAtualFeedback.textContent = 'A data da leitura atual não pode ser futura.';
                    DOM.dataAtualFeedback.style.display = 'block';
                    clearDependentDateFields();
                    return;
                }

                // Validação: não pode ser inferior à data da leitura anterior
                if (dataAnteriorStr) {
                    const partesDataAnterior = dataAnteriorStr.split('/');
                    const dataAnteriorFormatada = `${partesDataAnterior[2]}-${partesDataAnterior[1]}-${partesDataAnterior[0]}`;
                    const dataAnteriorDate = new Date(dataAnteriorFormatada + 'T00:00:00');

                    if (isNaN(dataAnteriorDate.getTime())) {
                        console.warn("Data da leitura anterior inválida no campo readonly:", dataAnteriorStr);
                        // Permite continuar com a validação da data atual, mas pode haver inconsistência se a anterior estiver errada
                    } else if (dataAtualDate < dataAnteriorDate) {
                        DOM.dataAtual.classList.add('is-invalid');
                        DOM.dataAtualFeedback.textContent = 'A data da leitura atual não pode ser anterior à data da leitura anterior.';
                        DOM.dataAtualFeedback.style.display = 'block';
                        clearDependentDateFields();
                        return;
                    }
                }
                
                // Se tudo OK, recalcula
                updateAllCalculations();
                updateVencimento();
            }

            function clearDependentDateFields() {
                DOM.diasUtilizados.value = '';
                DOM.mediaDiaria.value = '';
                DOM.vencimento.value = '';
                // Não limpamos valorOriginal e litrosConsumidos aqui, pois dependem mais da leitura atual do que da data válida.
                // Mas se preferir, pode limpar: DOM.litrosConsumidos.value = ''; DOM.valorOriginal.value = '';
            }


            function attachEventListeners() {
                DOM.consumidor.addEventListener('change', function() {
                    if (this.value) {
                        window.location.href = `/cadastrar-leitura?consumidor_id=${this.value}`;
                    }
                });

                DOM.leituraAtual.addEventListener('input', updateAllCalculations);
                DOM.valorTaxaMinima.addEventListener('input', updateAllCalculations);
                DOM.aplicarTaxaMinima.addEventListener('change', updateAllCalculations);
                
                DOM.dataAtual.addEventListener('change', validateAndRecalculateDates); // Chama a nova função de validação de datas

                // Adicionado um escutador no formulário para a submissão, para garantir que as validações estão OK antes de enviar
                document.querySelector('form').addEventListener('submit', function(event) {
                    // Re-valida as datas antes de enviar para garantir
                    validateAndRecalculateDates();
                    // Verifica se há algum campo 'is-invalid' antes de submeter
                    if (document.querySelector('.is-invalid')) {
                        event.preventDefault(); // Impede o envio do formulário
                        alert('Por favor, corrija os erros indicados no formulário antes de salvar.');
                    }
                });
            }

            async function init() {
                DOM.leituraAtualFeedback.style.display = 'none';
                DOM.dataAtualFeedback.style.display = 'none'; // Esconde o feedback de data no início

                try {
                    const [dataValor, dataDias] = await Promise.all([
                        fetch('/api/valor_m3').then(r => {
                            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                            return r.json();
                        }),
                        fetch('/api/dias_uteis').then(r => {
                            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                            return r.json();
                        })
                    ]);

                    appConfig.valorM3 = Utils.parseLocalFloat(dataValor.valor_m3);
                    appConfig.diasVencimento = parseInt(dataDias.dias_uteis) || 5;
                    
                    // Define a data atual como padrão se o campo estiver vazio
                    if (!DOM.dataAtual.value) {
                        const today = new Date();
                        DOM.dataAtual.value = today.toISOString().split('T')[0];
                    }
                    
                    // Realiza os cálculos iniciais e validações após carregar as configurações e preencher a data.
                    validateAndRecalculateDates(); 
                    updateAllCalculations(); // Já é chamado dentro de validateAndRecalculateDates se a data for válida
                    updateVencimento(); // Já é chamado dentro de validateAndRecalculateDates se a data for válida
                    attachEventListeners();
                } catch (error) {
                    console.error('Erro ao buscar configurações (valor_m3 ou dias_uteis):', error);
                    alert('Não foi possível carregar as configurações de preço ou vencimento. Por favor, recarregue a página.');
                }
            }
            
            init();
        });
    </script>
</body>
</html>